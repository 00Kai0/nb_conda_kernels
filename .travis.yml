language: generic
sudo: false

branches:
  only:
    - master
    - /^\d+\.\d+.*$/

os:
  - linux
  - osx

env:
  global:
    - secure: "p7m2lBeihiUl6Bs6plrg0svucvqspD7ecX+7AhexlobPUIVEaAnHMqqoV86KrtKeQKi8wICkleOQ6qxUVtaHXX5h7VtqjPQNUpr4TgBhb8T6+z7WL895T2GKnza1TWnvXRdQAfMFaqQ7PsNQgpO/DaOSGaxG8LThMi4OLtJisuUk06+KXFnxBv83jqshEujjJtErD4WUnWWTvdVWKjTdBERHdHf4xxuss4DrDn4ILw+uWg7EWNigGtsPxSpZlKWh7ap5PKHkLCYUL9U+Ons++k0dZuxtdnBMRaeQ82/hOpOXbolvU35/cthmhQkQfhZInyjFQORCCucqvKGfftRtFi683kMxrYnbU5mXp2TUGIj9pX5zCWbH06kqXXYpM16F6w7bKWKYrXrB//pgD7sawh86cLCiIzKbYOvAnZWp++UTOyAKvmSEPSa+Kq+9JnN+CQ6xZf+NlqnB+0xM44vlkmDxphxm3dWkjsgKtdX27gAbGxw3AJ+8M0rlJ4Uo2jURBVeCtDDTmW4Yb5utPVCXWXnkWWr7yS1voGafSG80XevOGQMu47gP9/6yb4UF4/P7JYjU2FjrmLBCJWc/9fTYm+3k9ggSXzRWEO39iN0520xIsKQ5130cMT5siQbDPCXV7LFaew0r/b8o/7jInnKI8XocSjKSrqR5bWIlVRfGCNo="
  matrix:
    - PYTHON_VERSION=2.7
    - PYTHON_VERSION=3.5
    - PYTHON_VERSION=3.6
    - PYTHON_VERSION=3.7
    - PYTHON_VERSION=3.5 CONDA_SPEC='=4.3'

install:
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O miniconda.sh;
    else
        wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    fi
  - bash miniconda.sh -b -p $HOME/miniconda
  # Fix the conda version before full activation
  - $HOME/miniconda/bin/conda install conda$CONDA_SPEC --yes
  - source $HOME/miniconda/bin/activate
  - conda config --set always_yes yes --set changeps1 no --set auto_update_conda no
  # The tests need to see the Python kernel in the root environment
  - conda install conda-verify conda-build ipykernel anaconda-client
  # We need to create additional environments to fully test the logic,
  # including an R kernel, a Python kernel, and environment names with
  # at least one non-ASCII character and one space. Because AppVeyor is
  # difficult to work with for non-ASCII content we're using env files.
  - conda env create -f conda-recipe/testenv1.yaml
  - conda env create -f conda-recipe/testenv2.yaml
  - conda info -a

script:
  - conda build conda-recipe --python=$PYTHON_VERSION

deploy:
  # Upload to main label for tagged master builds
  - provider: script
    skip_cleanup: true
    on:
      branch: master
      tags: true
    script: anaconda --verbose --token $ANACONDA_TOKEN upload --user jupycon $HOME/miniconda/conda-bld/*/*.tar.bz2 --force
  # Upload to dev label for untagged master builds
  - provider: script
    skip_cleanup: true
    on:
      branch: master
      tags: false
    script: anaconda --verbose --token $ANACONDA_TOKEN upload --user jupycon --label dev $HOME/miniconda/conda-bld/*/*.tar.bz2 --force
